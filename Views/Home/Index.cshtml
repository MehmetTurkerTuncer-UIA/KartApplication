@model KartApplication.Models.SakModel
@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_BrukerLayout.cshtml";
}

<br>
<center><h2>Velg Sted</h2></center>

<!-- Kartbeholder -->
<div id="map" style="height: 400px; width: 100%; position: relative;">
    <!-- Søkboksen i kartbeholderen -->
    <div id="search-container" style="position: absolute; top: 10px; right: 0; margin-right:10px; z-index: 1000; width: 360px;">
        <div class="input-group">
            <input type="text" id="searchInput" name="address" class="form-control" placeholder="Skriv inn full adresse" aria-label="Søk adresse" autocomplete="off" />
            <div class="input-group-append">
                <button type="button" class="btn-primary" id="searchAddressBtn">
                    <i class="bi bi-search black-icon"></i>
                </button>
            </div>
        </div>
        <!-- Forslagene vil vises her -->
        <div id="suggestions" class="suggestions-dropdown" style="display: none;"></div>
    </div>
</div>
<br />

<!-- Viser valgte koordinater som tabell -->
<h3>Valgte koordinater:</h3>
<table class="table table-bordered" id="coordinatesTable">
    <thead>
        <tr>
            <th>#</th>
            <th>Breddegrad</th>
            <th>Lengdegrad</th>
        </tr>
    </thead>
    <tbody id="coordinatesTableBody">
        <!-- Koordinater vil bli lagt til her -->
    </tbody>
</table>

<!-- Form -->
<form asp-controller="Home" asp-action="Index" method="post" onsubmit="return validateForm()">
    <input type="hidden" asp-for="Id" />   
    <input type="hidden" id="geoJsonInput" name="GeoJson" /> <!-- Skjult felt for GeoJSON-data -->
    <input type="hidden" id="addressInput" name="Address" /> <!-- Skjult felt for adresse -->
    <input type="hidden" id="selectedMapType" name="SelectedMapType" value="fargekart" /> <!-- Skjult felt for valgt karttype -->
    <br />
    <button type="submit" class="btn btn-primary" style="background-color: #006aff; color: white; padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer;">Neste</button>
</form>

@section Scripts {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

    <style>
        /* Stil for nedtrekksmeny for forslag */
        .suggestions-dropdown {
            position: absolute;
            background-color: white;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1001;
            width: 100%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 0;
            margin-top: 5px;
            border-radius: 5px;
        }

        /* Stil for kartminiatyrer */
        .map-thumbnails {
            position: absolute;
            bottom: 10px;
            left: 10px;
            display: flex;
            gap: 5px;
            z-index: 1000;
            background-color: rgb(255, 255, 255);
            padding: 5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 1.5);
            border-radius: 4px;
        }

        .map-thumbnail {
            position: relative;
            width: 48px;
            height: 48px;
            border: 3px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            transition: border-color 0.3s ease;
            overflow: visible;
            border-color: rgba(255, 166, 0, 0.266);
        }

        .map-thumbnail:hover {
            border-color: rgb(125, 82, 0);
        }

        .map-thumbnail .map-title {
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
            margin-bottom: 5px;
        }

        .map-thumbnail:hover .map-title {
            opacity: 1;
        }

        .map-thumbnail .map-title::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 10px;
            border-style: solid;
            border-color: black transparent transparent transparent;
            opacity: 0.7;
            z-index: 1001;
        }

        .map-thumbnail.selected {
            border-color: orange;
        }

        .map-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .suggestion-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #ddd;
            color: black;
        }

        .suggestion-item:hover {
            background-color: #f0f0f0;
        }

        .suggestion-title {
            font-weight: bold;
            font-size: 14px;
        }

        .suggestion-address {
            font-size: 12px;
            color: black;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <script>
        // Initialiser kartet
        var map = L.map('map').setView([58.1467, 7.9956], 15);

        // Kartverket Fargekart
        var fargekart = L.tileLayer('https://cache.kartverket.no/v1/wmts/1.0.0/topo/default/webmercator/{z}/{y}/{x}.png', {
            maxZoom: 18,
            attribution: '&copy; <a href="https://kartverket.no/">Kartverket</a>'
        }).addTo(map); // Start med Fargekart

        // Kartverket Gråtonekart
        var gratonekart = L.tileLayer('https://cache.kartverket.no/v1/wmts/1.0.0/topograatone/default/webmercator/{z}/{y}/{x}.png', {
            maxZoom: 18,
            attribution: '&copy; <a href="https://kartverket.no/">Kartverket</a>'
        });

        // Kartverket Turkart
        var turkart = L.tileLayer('https://cache.kartverket.no/v1/wmts/1.0.0/toporaster/default/webmercator/{z}/{y}/{x}.png', {
            maxZoom: 18,
            attribution: '&copy; <a href="https://kartverket.no/">Kartverket</a>'
        });

        // Kartverket Sjøkart
        var sjokart = L.tileLayer('https://cache.kartverket.no/v1/wmts/1.0.0/sjokartraster/default/webmercator/{z}/{y}/{x}.png', {
            maxZoom: 18,
            attribution: '&copy; <a href="https://kartverket.no/">Kartverket</a>'
        });

        // Legg til Fargekart som startkart
        var currentLayer = fargekart;
        var selectedMapType = 'fargekart'; // Standard karttype

        // Legg til kartvalg som små ruter nederst til venstre
        var thumbnailsContainer = document.createElement('div');
        thumbnailsContainer.classList.add('map-thumbnails');
        document.getElementById('map').appendChild(thumbnailsContainer);

        // Legg til miniatyrbilder for kartene
        var maps = [
            { id: 'fargekart', layer: fargekart, imageUrl: '@Url.Content("~/images/4.png")', title: 'Fargekart' },
            { id: 'gratonekart', layer: gratonekart, imageUrl: '@Url.Content("~/images/3.png")', title: 'Gråtonekart' },
            { id: 'turkart', layer: turkart, imageUrl: '@Url.Content("~/images/2.png")', title: 'Turkart' },
            { id: 'sjokart', layer: sjokart, imageUrl: '@Url.Content("~/images/1.png")', title: 'Sjøkart' }
        ];

        maps.forEach(function(mapInfo, index) {
            var thumbnailDiv = document.createElement('div');
            thumbnailDiv.classList.add('map-thumbnail');
            if (index === 0) {
                thumbnailDiv.classList.add('selected');
            }

            var img = document.createElement('img');
            img.src = mapInfo.imageUrl;
            img.alt = mapInfo.title;
            thumbnailDiv.appendChild(img);

            // Legg til tittel som ny div
            var titleDiv = document.createElement('div');
            titleDiv.classList.add('map-title');
            titleDiv.textContent = mapInfo.title; // Legg til kartnavnet som tekst
            thumbnailDiv.appendChild(titleDiv);

            thumbnailsContainer.appendChild(thumbnailDiv);

            // Endre kart når du klikker
            thumbnailDiv.addEventListener('click', function() {
                if (currentLayer !== mapInfo.layer) {
                    map.removeLayer(currentLayer);
                    map.addLayer(mapInfo.layer);
                    currentLayer = mapInfo.layer;

                    // Oppdater verdien for valgt karttype
                    selectedMapType = mapInfo.id;
                    document.getElementById('selectedMapType').value = selectedMapType;

                    // Oppdater valgt klasse
                    document.querySelectorAll('.map-thumbnail').forEach(function(thumb) {
                        thumb.classList.remove('selected');
                    });
                    thumbnailDiv.classList.add('selected');
                }
            });
        });

        // Tegnefunksjonalitet
        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        var drawControl = new L.Control.Draw({
            edit: {
                featureGroup: drawnItems,
                edit: true,
                remove: true
            },
            draw: {
                polygon: true,
                polyline: true,
                rectangle: true,
                circle: false,
                circlemarker: false,
                marker: true
            }
        });
        map.addControl(drawControl);

        // Funksjon som oppdaterer GeoJSON
        function updateGeoJson() {
            var allLayers = [];
            drawnItems.eachLayer(function(layer) {
                var geoJson = layer.toGeoJSON();
                allLayers.push(geoJson);
            });

            var featureCollection = {
                "type": "FeatureCollection",
                "features": allLayers
            };

            document.getElementById('geoJsonInput').value = JSON.stringify(featureCollection);
        }

        // Funksjon som oppdaterer adresseinput-feltet
        function updateAddressInput(lat, lng) {
            var url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&accept-language=no`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    var address = data.display_name ? data.display_name : "Adresse ikke funnet";
                    document.getElementById('searchInput').value = address;
                    document.getElementById('addressInput').value = address;
                })
                .catch(error => {
                    console.error('Feil ved henting av adresse:', error);
                    document.getElementById('searchInput').value = "Feil ved henting av adresse";
                });
        }

        // Funksjon som legger til/oppdaterer koordinater i tabellen
        function updateCoordinatesTable(layer) {
            var tbody = document.getElementById('coordinatesTableBody');
            tbody.innerHTML = '';

            if (layer instanceof L.Marker) {
                var latLng = layer.getLatLng();
                var row = `<tr><td>1</td><td>${latLng.lat}</td><td>${latLng.lng}</td></tr>`;
                tbody.innerHTML = row;
            } else if (layer instanceof L.Polygon || layer instanceof L.Polyline || layer instanceof L.Rectangle) {
                var latlngs = layer.getLatLngs();
                var counter = 1;

                latlngs.forEach(function(latlngArray) {
                    if (Array.isArray(latlngArray)) {
                        latlngArray.forEach(function(latlng) {
                            var row = `<tr><td>${counter}</td><td>${latlng.lat}</td><td>${latlng.lng}</td></tr>`;
                            tbody.innerHTML += row;
                            counter++;
                        });
                    } else {
                        var row = `<tr><td>${counter}</td><td>${latlngArray.lat}</td><td>${latlngArray.lng}</td></tr>`;
                        tbody.innerHTML += row;
                        counter++;
                    }
                });
            }
        }

        // Legg til ny lag når tegningen er fullført
        map.on('draw:created', function(event) {
            var layer = event.layer;
            if (drawnItems.getLayers().length > 0) {
                drawnItems.clearLayers();
            }
            drawnItems.addLayer(layer);
            updateGeoJson();
            updateCoordinatesTable(layer);

            if (layer instanceof L.Marker) {
                var latLng = layer.getLatLng();
                updateAddressInput(latLng.lat, latLng.lng);
            }
        });

        map.on('draw:edited', function () {
            var layers = drawnItems.getLayers();
            if (layers.length > 0) {
                updateGeoJson();
                updateCoordinatesTable(layers[0]);
            }
        });

        map.on('draw:deleted', function () {
            updateGeoJson();
            document.getElementById('coordinatesTableBody').innerHTML = '';
        });

        // Oppdater skjult inputfelt når adressen skrives inn manuelt
        document.getElementById('searchInput').addEventListener('input', function() {
            document.getElementById('addressInput').value = this.value;
        });

        // Søkeadressefunksjon
        function searchAddress() {
            var address = document.getElementById('searchInput').value;
            if (address) {
                var url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(address)}`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length > 0) {
                            var lat = data[0].lat;
                            var lon = data[0].lon;

                            drawnItems.clearLayers();
                            var marker = L.marker([lat, lon]).addTo(drawnItems);
                            map.setView([lat, lon], 15);

                            updateGeoJson();
                            updateCoordinatesTable(marker);
                        } else {
                            alert('Adresse ikke funnet.');
                        }
                    })
                    .catch(error => {
                        console.error('Feil ved henting av adresse:', error);
                        alert('Feil ved henting av adresse.');
                    });
            } else {
                alert('Vennligst skriv inn en adresse.');
            }
        }

        // Vise adresseforslag
        document.getElementById('searchInput').addEventListener('input', function() {
            var query = this.value;
            if (query.length > 0) {
                var url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&q=${encodeURIComponent(query)}`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        var suggestions = document.getElementById('suggestions');
                        suggestions.innerHTML = '';
                        suggestions.style.display = 'block';

                        data.slice(0, 3).forEach(function(item) {
                            if (item.display_name.includes('Norveç')) {
                                var street = item.address.road || item.address.pedestrian || item.address.highway || '';
                                var house_number = item.address.house_number || '';
                                var city = item.address.city || item.address.village || '';
                                var county = item.address.county || '';
                                var country = "Norge";

                                var option = document.createElement('div');
                                option.classList.add('suggestion-item');
                                option.innerHTML = `
                                    <div class="suggestion-title">${street} ${house_number}</div>
                                    <div class="suggestion-address">${city}, ${county}, ${country}</div>
                                `;
                                option.addEventListener('click', function() {
                                    document.getElementById('searchInput').value = `${street} ${house_number}, ${city}, ${county}, ${country}`;
                                    suggestions.innerHTML = '';
                                    suggestions.style.display = 'none';

                                    var lat = item.lat;
                                    var lon = item.lon;
                                    drawnItems.clearLayers();
                                    var marker = L.marker([lat, lon]).addTo(drawnItems);
                                    map.setView([lat, lon], 15);
                                    updateGeoJson();
                                    updateCoordinatesTable(marker);
                                });
                                suggestions.appendChild(option);
                            }
                        });
                    })
                    .catch(error => console.error('Feil ved henting av forslag:', error));
            }
        });

        // Utfør søk når søkeknappen klikkes
        document.getElementById('searchAddressBtn').addEventListener('click', searchAddress);
        document.getElementById('searchInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                searchAddress();
            }
        });
    </script>
}
