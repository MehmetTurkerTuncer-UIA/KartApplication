@model KartApplication.Models.SakModel
@{
    ViewData["Title"] = "Beskrivelse";
    Layout = "~/Views/Shared/_BrukerLayout.cshtml";
}

<br>
<center><h2>Beskrivelse1</h2></center>

<!-- Beskrivelse form -->
<form asp-controller="Home" asp-action="Beskrivelse" method="post">

    <input type="hidden" asp-for="Id" /> @* Lagt til *@
    <input type="hidden" id="selectedMapType" name="SelectedMapType" value="fargekart" />

    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <!-- Meldingsfeltet til venstre (textarea) -->
        <div style="width: 48%;">
            <label for="description" style="color: white; display: block; margin-bottom: 10px;">Beskrivelse:</label>
<textarea id="description" name="Description" class="form-control" required 
    style="width: 100%; height: 200px; background-color: #333; color: white; 
    border: 1px solid #ccc; border-radius: 5px; padding: 10px;"
    onfocus="removePlaceholder()" onblur="addPlaceholder()">Skriv en beskrivelse...</textarea>
            </div>

        <!-- Kart og tittel til høyre -->
        <div style="width: 48%;">
            <!-- Karttittel -->
            <label for="map" style="color: white; display: block; margin-bottom: 10px;">Kartvisning:</label>
            <div id="map" style="height: 400px; width: 100%; background-color: lightgray;"></div>

            <!-- Vis adresseinformasjon hvis tilgjengelig (under kartet) -->
            @if (!string.IsNullOrEmpty(Model.Address))
            {
                <div style="margin-top: 15px;">
                    <p><strong>Adresse:</strong> @Model.Address</p>
                </div>
            }
        </div>
    </div>

    <br />

    <!-- Knappene nederst på samme linje -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
        <!-- Tilbake-knappen til venstre -->
        <button type="button" class="btn" style="background-color: gray; color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer;" onclick="window.location.href='@Url.Action("Index", "Home")'">Tilbake</button>
        <!-- Neste (Lagre og fortsett) knapp til høyre -->
        <button type="submit" class="btn btn-primary" style="background-color: #006aff; color: white; padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer;">Neste</button>
    </div>
</form>

@section Scripts {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Henter GeoJSON-data fra modellen
        var geoJsonData = @Html.Raw(Model.GeoJson);
        var selectedMapType = '@Model.SelectedMapType'; // Valgt karttype (fargekart, gratonekart, turkart, sjokart)

        // Definer kartlagene
        var fargekart = L.tileLayer('https://cache.kartverket.no/v1/wmts/1.0.0/topo/default/webmercator/{z}/{y}/{x}.png', {
            maxZoom: 18,
            attribution: '&copy; <a href="https://kartverket.no/">Kartverket</a>'
        });

        var gratonekart = L.tileLayer('https://cache.kartverket.no/v1/wmts/1.0.0/topograatone/default/webmercator/{z}/{y}/{x}.png', {
            maxZoom: 18,
            attribution: '&copy; <a href="https://kartverket.no/">Kartverket</a>'
        });

        var turkart = L.tileLayer('https://cache.kartverket.no/v1/wmts/1.0.0/toporaster/default/webmercator/{z}/{y}/{x}.png', {
            maxZoom: 18,
            attribution: '&copy; <a href="https://kartverket.no/">Kartverket</a>'
        });

        var sjokart = L.tileLayer('https://cache.kartverket.no/v1/wmts/1.0.0/sjokartraster/default/webmercator/{z}/{y}/{x}.png', {
            maxZoom: 18,
            attribution: '&copy; <a href="https://kartverket.no/">Kartverket</a>'
        });

        // Start kartet med valgt kartlag
        var selectedLayer;
        switch (selectedMapType) {
            case 'gratonekart':
                selectedLayer = gratonekart;
                break;
            case 'turkart':
                selectedLayer = turkart;
                break;
            case 'sjokart':
                selectedLayer = sjokart;
                break;
            default:
                selectedLayer = fargekart;
        }

        // Initialiser kartet
        var map = L.map('map').setView([58.1467, 7.9956], 15);

        // Legg til valgt kartlag
        selectedLayer.addTo(map);

        // Legg til GeoJSON-data til kartet
        if (geoJsonData && geoJsonData.features) {
            var layer = L.geoJSON(geoJsonData, {
                onEachFeature: function (feature, layer) {
                    // Hvis funksjonen er et punkt (markør)
                    if (feature.geometry.type === 'Point') {
                        var lat = feature.geometry.coordinates[1];
                        var lng = feature.geometry.coordinates[0];
                        layer.bindPopup("Koordinater: Br. " + lat + ", Lgr. " + lng).openPopup();
                    }
                    // Hvis funksjonen er en polygon
                    else if (feature.geometry.type === 'Polygon') {
                        feature.geometry.coordinates[0].forEach(function (coord) {
                            var lat = coord[1];
                            var lng = coord[0];
                            L.marker([lat, lng]).addTo(map)
                                .bindPopup("Koordinater: Br. " + lat + ", Lgr. " + lng).openPopup();
                        });
                    }
                    // Hvis funksjonen er en linje (Polyline)
                    else if (feature.geometry.type === 'LineString') {
                        feature.geometry.coordinates.forEach(function (coord) {
                            var lat = coord[1];
                            var lng = coord[0];
                            L.marker([lat, lng]).addTo(map)
                                .bindPopup("Koordinater: Br. " + lat + ", Lgr. " + lng).openPopup();
                        });
                    }
                }
            }).addTo(map);

            // Tilpass kartvisningen til lagene
            map.fitBounds(layer.getBounds());

        } else {
            // Hvis GeoJSON-data mangler, vis en advarsel
            alert('Gyldige GeoJSON-data ble ikke funnet.');
        }

        // Fjern placeholder når feltet fokuseres
        function removePlaceholder() {
            var textarea = document.getElementById("description");
            if (textarea.value === "Skriv en beskrivelse...") {
                textarea.value = "";
                textarea.style.color = "white";
            }
        }

        // Legg til placeholder når feltet mister fokus
        function addPlaceholder() {
            var textarea = document.getElementById("description");
            if (textarea.value === "") {
                textarea.value = "Skriv en beskrivelse...";
                textarea.style.color = "gray";
            }
        }

        // Sett placeholder-farge når siden lastes inn
        document.addEventListener("DOMContentLoaded", function() {
            var textarea = document.getElementById("description");
            textarea.style.color = "gray";
        });
    </script>
}
